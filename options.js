const s=document.getElementById("status"),t=document.getElementById("tableContainer");let e=[];document.getElementById("excelFile").addEventListener("change",function(){const t=this.files[0]?.name||"未选择文件";document.getElementById("fileName").textContent=t});function n(t){const e=document.createElement("div");e.textContent=t,s.appendChild(e),s.scrollTop=s.scrollHeight}function o(s){if(!s.length)return;const r=Object.keys(s[0]),l={"品名":"10%","沃尔玛ITEM ID":"10%","独立站链接":"20%","评论内容":"40%","名字":"5%","邮箱":"10%"};let a="<table><colgroup>";a+='<col style="width: 5%;">',r.forEach((t=>{const e=l[t]||"15%";a+=`<col style="width: ${e};">`})),a+="</colgroup><thead><tr>",a+="<th>序号</th>",r.forEach((t=>{a+=`<th>${t}</th>`})),a+="</tr></thead><tbody>",s.forEach(((s,l)=>{a+=`<tr><td>${l+1}</td>`,r.forEach((t=>{a+=`<td>${s[t]??""}</td>`})),a+="</tr>"})),a+="</tbody></table>",t.innerHTML=a}document.getElementById("excelFile").addEventListener("change",async l=>{t.innerHTML="",n("开始上传 Excel 文件...");try{const t=l.target.files[0];if(!t)return void n("未选中文件！");n("读取文件："+t.name);const s=await t.arrayBuffer(),r=XLSX.read(s,{type:"array"}),a=r.Sheets[r.SheetNames[0]],i=XLSX.utils.sheet_to_json(a);if(!i.length)return void n("Excel 内容为空！");n("读取成功，共 "+i.length+" 条数据"),n(" "),n(" "),e=i,o(e)}catch(t){n("读取失败: "+t.message)}}),document.getElementById("run").addEventListener("click",async()=>{if(!e.length)return void n("请先上传 Excel 文件！");const s=parseFloat(document.getElementById("intervalInput").value)||0,t=1e3*s+2e3;for(let r=0;r<e.length;r++){const l=e[r],a=r+1;try{n(`序号${a}：正在打开链接 ${l["独立站链接"]}`);const r=await new Promise(((t,e)=>{chrome.tabs.create({url:l["独立站链接"]},(s=>{chrome.runtime.lastError?e(chrome.runtime.lastError):t(s)}))}));await new Promise((t=>{const e=(s,l)=>{s===r.id&&"complete"===l.status&&(chrome.tabs.onUpdated.removeListener(e),t())};chrome.tabs.onUpdated.addListener(e)})),n(`序号${a}：正在填写数据...`),await chrome.scripting.executeScript({target:{tabId:r.id},func:d,args:[l]}),n(`序号${a}：完成填写并提交 ✔`),t>0&&(n(`等待 ${s} 秒后继续下一条...`),await new Promise((e=>setTimeout(e,t)))),await new Promise(((t,e)=>{chrome.tabs.remove(r.id,(()=>{chrome.runtime.lastError?(n(`序号${a}：关闭标签页失败 ${chrome.runtime.lastError.message}`),t()):t()}))}))}catch(t){n(`序号${a}：操作失败 ❌  ${t.message}`)}}n("全部操作完成！🎉")});function d(s){const t=(s,t)=>{const e=document.querySelector(s);e&&(e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})))};
t("#comment",s["评论内容"]),t("#author",s["名字"]),t("#email",s["邮箱"]);const e=document.querySelector("p.stars");if(e){e.classList.add("selected");const s=e.querySelector("a.star-5");s&&(s.classList.add("active"),s.click())}const n=document.querySelector("#submit");n&&n.click()}
